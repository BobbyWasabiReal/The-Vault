<%- include('../partials/header') %>

<section id="item-page">
    <label class="label">Image of Item:</label>
    <div class="item-div"><img src="<%= item.itemImg %>" alt="item" class="details-img"></div> <br>
    <label class="label">Item Name:</label>
    <div class="item-div"><%= item.item %></div> <br>
    <label class="label">Game:</label>
    <div class="item-div"><%= item.game %></div> <br>
    <label class="label">Item Level:</label>
    <div class="item-div"><%= item.itemLevel %></div> <br>
    <label class="label">Up For Trade:</label>
    <div class="item-div"><%= item.upForTrade ? 'Yes' : 'No' %></div> <br>
    <label class="label">Description:</label>
    <div class="item-div"><%- item.description.replaceAll('\n', '<br>') %></div>
</section> <br>

<section id="reviews">
<h1>Reviews</h1>
<% if (user) { %>
  <form id="review-form" method="POST"
    action="/items/<%= item._id %>/reviews">
    <label>Review:</label> <br>
    <textarea name="content"></textarea> <br>
    <label>Rating:</label> <br>
    <select name="rating">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10" selected>10</option>
    </select> <br> <br>
    <input type="submit" value="Add Review" class="btn">
  </form>
<% } else { %>
    <h2>Sign in to make reviews.</h2>
<% } %>

    <% if (item.reviews.length) { %>
        <table>
          <thead>
            <tr>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% let total = 0 %>
            <% item.reviews.forEach(function(r) { %>
              <% total += r.rating %>
              <tr>
                <td>
                    <h2><img alt="avatar" src="<%= r.userAvatar %>" referrerpolicy="no-referrer" class="user"><%= r.userName %></h2> <br>
                    <%= r.createdAt.toLocaleDateString() %> <br>
                    <h2><%= r.content %></h2>
                    <%= r.rating %> <br>
                    <% if (user?._id.equals(r.user)) { %>
                      <form action="/reviews/<%= r._id %>?_method=DELETE" method="POST">
                        <button type="submit">X</button>
                      </form>
                    <% } %>
                </td>
              </tr>
            <% }); %>
            <tr>
              <td colspan="2"></td>
              <td>
                <strong>
                  Total Score: <%= total %>
                </strong>
              </td>
            </tr>
          </tbody>
        </table>
      <% } else { %>
        <h5>No Reviews Yet</h5>
      <% } %>
</section>

<%- include('../partials/footer') %>